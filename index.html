<!doctype html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, user-scalable=yes" />
<style>
	html, body {
    margin:0;
    border: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background-color: #3e3e3e;
    -moz-transition: all 10s ease-in;
    -webkit-transition: all 10s ease-in;
    -o-transition: all 10s ease-in;
    transition: all 10s ease-in;
       	}

	#sketch {
 	margin: 0 auto;
	}
	
	#logmessage {
				color: white;
				display: block;
				font-size: 0.9em;
				position: absolute;
				bottom: 0px;
				left: 10px;
				padding-right: 10px;
				font: "Helvetica Neue", Arial, Helvetica, sans-serif;
	}
	
	#timeframe {
		color: white;
		display: block;
		font-size: 0.9em;
		position: absolute;
		top: 0px;
		right: 10px;
		padding-left: 10px;
		font: "Helvetica Neue", Arial, Helvetica, sans-serif;
	}
	
	#timeframe a {
		color: white;
		}
	
	</style>
	
</head>
<title>Demo</title>
<body>
<p id="timeframe">Time: <a href="#" id="TenSec">10 sec</a> / <a href="#" id="OneMin">1 min</a> / <a href="#" id="TenMin">10 min</a> </p>
<canvas id="sketch" keepalive="true"></canvas>
<div id="tweets"></div> 
<script src="/socket.io/socket.io.js"></script>
<script src="http://www.jacopocolo.com/pulse/js/randomColor.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script>
window.onload = function() {
	//SETUP
	//GET SEARCH TERM (url/?search=SEARCHTERM)
	var quiturlquery = false;
	function getQueryVariable(variable)
	{ if (quiturlquery == false) {
	
	       var query = window.location.search.substring(1);
	       var vars = query.split("&");
	       for (var i=0;i<vars.length;i++) {
	               var pair = vars[i].split("=");
	               if(pair[0] == variable){return pair[1];
	               quiturlquery = true;}
	       }
	       return;
	       }
	};
	ricerca = getQueryVariable("search");
	
	//SET BACKGROUND COLOR
	function refreshData()
	{x = 10;
	document.body.style.backgroundColor=randomColor({luminosity: 'dark',hue: 'monochrome'});    
	setTimeout(refreshData, x*1000);
	}
	refreshData()
	
	//CANVAS SETUP
	var canvas = document.getElementById('sketch');
	ctx = canvas.getContext("2d");
	//SET CANVAS SIZE
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	console.log(canvas.width, canvas.height);
	//SET GLOBAL VARS
	//WHERE DO I STOP DRAWING?
	var limite;
	calclimite = function() {
		if (window.innerHeight >= window.innerWidth){
			limite = window.innerHeight;
			console.log(limite);
			} else {
				limite = window.innerWidth;
				console.log(limite);
				};
		};
	calclimite();
	
	//SPEED is based on the largest portion of the window. With a fps of 30, if you divide it by 30 it means that every second my wave exit the canvas, if you devide it by 300, it means that every 10 seconds the wave exits the canvas
	var speed = limite/300;
	$('#TenSec').click(function() {speed = limite/300; return false;});
	$('#OneMin').click(function() {speed = limite/1800; return false;});
	$('#TenMin').click(function() {speed = limite/18000; return false;});
		
	var circles = new Array();
	
	//CROSS BROWSER ANIMATIONS
	var requestAnimationFrame = window.requestAnimationFrame || 
	                            window.mozRequestAnimationFrame ||
	                            window.webkitRequestAnimationFrame ||
	                            window.msRequestAnimationFrame;
	
	function Circle(halfx, halfy, width, radius, color) {
	            this.x = halfx;
	            this.y = halfy;
	            this.width = width;
	            this.color = color;
	            this.radius = radius;              
	            }
	
	Circle.prototype.update = function () {
	    ctx.beginPath();
	    ctx.arc(this.x, 
	            this.y, 
	            this.radius,
	            0, 
	            Math.PI * 2,
	            false);
	    ctx.closePath();
	    ctx.strokeStyle = this.color;
	    ctx.lineWidth = this.width;
	    ctx.stroke();
	   
	    if (this.radius <= limite) {
	    	this.radius+=speed;
	    		}
	    else {
			this.radius = this.radius;
		}
	    
	}; 
	
	//I PARAMETRI DEI CERCHI
	function drawCircle(data_followers) {
	
	var spessore;
	
		if (data_followers < 10) {
		spessore = 0.5
		} else if (data_followers > 10 && data_followers <= 100) {
		spessore = 1
		} else if (data_followers > 100 && data_followers <= 1000) {
		spessore = 2
		} else if (data_followers > 1000 && data_followers <= 10000) {
		spessore = 3
		} else if (data_followers > 10000 && data_followers <= 100000) {
		spessore = 4
		} else if (data_followers > 1000000) {spessore = 5};
	
	var halfx = window.innerWidth/2;
	var halfy = window.innerHeight/2;
	var width = spessore;
	var radius = 0;
	var color = randomColor({luminosity: 'light'});
	 
	var circle = new Circle(halfx, halfy, width, radius, color);
	circles.push(circle);
	//drawAndUpdate();
	};
	
	//SOCKET.IO
	var socket = io.connect('/'),
	  
	  tweets = document.getElementById('tweets');
	  socket.on('tweet', function (data, data_followers, datacolore) {
	    //console.log(data);
	    $('#logmessage').text(data);
	    drawCircle(data_followers);
	    });
	  
	  socket.on('connect', function(){
	                      socket.emit('search', prompt('cosa vuoi cercare?', 'beyonce'));
		});
	                  
	  socket.on('connected', function() {
	  	console.log('connesso');
	  	$('body').append("<p id=\"logmessage\">Waiting for the first tweetâ€¦</p>");
	  });
	  
	 
	var drawAndUpdate = function() {
	     ctx.clearRect(0, 0, canvas.width, canvas.height);
	  
	     for (var i = 0; i < circles.length; i++) {
	         var myCircle = circles[i];
	         myCircle.update();
	     }
	      
	     setTimeout(function() {
	         requestAnimationFrame(drawAndUpdate);
	         }, 1000 / 30);
	 };
	 
	 drawAndUpdate();
 };
</script>
</body>